{
  "id": null,
  "title": "NestJS Application Metrics",
  "timezone": "browser",
  "schemaVersion": 30,
  "version": 1,
  "panels": [
    {
      "type": "stat",
      "title": "Total API Requests",
      "targets": [
        {
          "expr": "sum(api_requests_total)",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "stat",
      "title": "API Errors",
      "targets": [
        {
          "expr": "sum(api_errors_total)",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "graph",
      "title": "Requests by Route/Status",
      "targets": [
        {
          "expr": "sum by (method, route, status_code) (api_requests_total)",
          "legendFormat": "{{method}} {{route}} [{{status_code}}]",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 3, "w": 12, "h": 6 }
    },
    {
      "type": "graph",
      "title": "Request Duration (Average)",
      "targets": [
        {
          "expr": "sum(api_request_duration_seconds_sum) / sum(api_request_duration_seconds_count)",
          "legendFormat": "avg duration (s)",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 9, "w": 12, "h": 6 }
    },
    {
      "type": "graph",
      "title": "Request Duration (p90)",
      "targets": [
        {
          "expr": "histogram_quantile(0.90, sum by (le) (rate(api_request_duration_seconds_bucket[5m])))",
          "legendFormat": "p90",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 15, "w": 6, "h": 6 }
    },
    {
      "type": "graph",
      "title": "Request Duration (p99)",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum by (le) (rate(api_request_duration_seconds_bucket[5m])))",
          "legendFormat": "p99",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 6, "y": 15, "w": 6, "h": 6 }
    },
    {
      "type": "graph",
      "title": "CPU Usage (seconds)",
      "targets": [
        {
          "expr": "rate(process_cpu_seconds_total[1m])",
          "legendFormat": "CPU",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 21, "w": 6, "h": 6 }
    },
    {
      "type": "graph",
      "title": "Memory Usage (Heap Used / RSS)",
      "targets": [
        {
          "expr": "process_resident_memory_bytes",
          "legendFormat": "RSS",
          "refId": "A"
        },
        {
          "expr": "nodejs_heap_size_used_bytes",
          "legendFormat": "Heap Used",
          "refId": "B"
        }
      ],
      "gridPos": { "x": 6, "y": 21, "w": 6, "h": 6 }
    },
    {
      "type": "graph",
      "title": "Event Loop Lag",
      "targets": [
        {
          "expr": "nodejs_eventloop_lag_mean_seconds",
          "legendFormat": "mean lag",
          "refId": "A"
        },
        {
          "expr": "nodejs_eventloop_lag_p99_seconds",
          "legendFormat": "p99 lag",
          "refId": "B"
        }
      ],
      "gridPos": { "x": 0, "y": 27, "w": 12, "h": 6 }
    },
    {
      "type": "graph",
      "title": "GC Duration",
      "targets": [
        {
          "expr": "rate(nodejs_gc_duration_seconds_sum[5m]) / rate(nodejs_gc_duration_seconds_count[5m])",
          "legendFormat": "{{kind}} avg duration",
          "refId": "A"
        }
      ],
      "gridPos": { "x": 0, "y": 33, "w": 12, "h": 6 }
    }
  ]
}
